% !TeX root = 2nd-course-in-latex.tex
% (The appearance of \documentclass in the examples confuses LaTeX Workshop for VS Code)

\chapter{Programming}

What really is \LaTeX?

It all starts with \TeX, the typesetting system designed by Donald Knuth in late 70s and 80s.
\TeX{} is a powerful system for laying out text,
but it puts a lot of responsibility on the writer.
Essentially, you are responsible for both the content and its presentation.

\LaTeX{} (originally by Leslie Lamport, now maintained by several people)
extends this core by introducing commands like \cmd{section}:
this command not only lays out the section title in a bigger font,
but also adds some vertical whitespace around it, updates the current section number,
adds an entry to the table of contents, and so on.
This \emph{separates the content from how it is presented}.

We will try to emphasize this philosophy on this course.
By using standard constructs, packages, and our own custom commands,
we can make the \verb|.tex| source code \emph{semantically} meaningful:
something that you could read aloud.
The system then makes sure that the output looks great on paper
-- isn't that why we ever wanted computers to exist!


\begin{warning}
Even when using \LaTeX{}, the old \TeX{} is still there.
It is possible to use plain-\TeX{} commands in your documents,
but \emph{this is highly discouraged}.
These commands sidestep all the enhancements brought by \LaTeX,
and might cause hard-to-diagnose problems.
You might need them when writing more complicated packages,
but then you are already solidly in the ``you are free to shoot your own foot'' territory.
Some such commands are noted in these Warning boxes.

Unfortunately, many heritage templates and Stack Exchange answers still mix
\TeX{}, \LaTeX, and pre-1994 \LaTeX.
Examples of the latter include the obsolete \obscmd{bf} and \obscmd{it} commands
(e.g.\ writing \verb|{\bf bold}| instead of \verb|\textbf{bold}|).
\end{warning}


\begin{latexthree}
The ``standard'' \LaTeX{} version is $2\varepsilon$, released in 1994.
\LaTeX3 is a long-running project (started already before $2\varepsilon$, and reactivated around 2018)
on rewriting the internals of \LaTeX{} to be more extensible.

\LaTeX3 introduces new commands for defining commands and environments.
We will only discuss the version $2\varepsilon$ methods (which are still valid) here,
but if you find yourself writing a package, you should consider learning about the new methods.%
\footnotemark

We will talk about some new features and accessibility improvements brought by \LaTeX3 below,
starting already in \Cref{sec:document structure}.
\end{latexthree}
\footnotetext{\url{www.latex-project.org/help/documentation/usrguide.pdf}}



%
%
%
\section{How \LaTeX{} processes files}

The design of the \TeX{} compiler is limited by the era it was conceived in.
Computer memory was a scarce resource in the 1980s,
so the compiler remembers as little as possible.

In particular, \TeX{} reads its source files from top to bottom.
It never backtracks,
which makes it impossible to reference things that have not yet been defined.

How is it then possible to create cross-references to upcoming sections?
Whenever a \cmd{label} command is encountered,
its name and position is recorded to an \verb|.aux| file.\index{aux file@.aux file}
\LaTeX{} reads in this file before it starts processing the \verb|.tex| file.

Consequently:
\begin{enumerate}
\item On the first compilation, an \verb|.aux| file is generated.
\item On subsequent compilations, cross-references are resolved
    using the \verb|.aux| file from the preceding compilation.
\item This means that all page number references point to \emph{the state of the previous compilation}.
\item Since the resolution might change page numbering,
    it might be necessary to iterate.
    \LaTeX{} gives the
    ``\texttt{Label(s) may have changed. Rerun to get cross-references right.}''
    warning if this is the case.
\item For well-behaved documents, at most three compilations should give convergence.
\end{enumerate}

\begin{warning}
Sometimes, a typo'ed command might end up messing the \verb|.aux| file.
In this case, fixing the error and recompiling will not be enough,
since the \verb|.aux| file feeds back incorrect data.

Usually, the \verb|.aux| file from the recompilation is no longer erroneous,
so a second recompilation is enough.

Rarely, the state might be so messed that the \verb|.aux| file gets re-corrupted
before the compilation halts.
This manifests itself as weird compilation errors even
when you have reverted your code back to a known good state.
If this happens, delete the auxiliary files and recompile from scratch.
Some \LaTeX{} editors have even a handy button for this.
\end{warning}

Since this is the only mechanism for creating forward references,
the \verb|.aux| file is not the only one of its kind.
Some other temporary files that you can expect to see in your compilation folder:
\begin{description}
\newcommand{\filetype}[1]{\item[\texttt{.#1}]\index{#1 file@.#1 file}}
\filetype{bbl} The bibliography generated by the bibliography compiler.
    See below and \Cref{sec:bibliography}.
    Some publishers, in particular arXiv,
    require you to submit this file together with your source code.
\filetype{idx} Index created by the \prg{makeindex} program (\Cref{sec:index}).
\filetype{lof} List of figures.
\filetype{log} This is the raw compiler log.
    \LaTeX{} editors parse this into a more readable form,
    but long, multi-line error messages can be easier to read from the raw log.
\filetype{lot} List of tables.
\filetype{synctex.gz} This is used by some editors to synchronize
    the scrolling of PDF and source code.
\filetype{thm} Theorems (\pkg{ntheorem} package).
\filetype{toc} Table of contents.
\end{description}
%
This list is not exhaustive;
several packages produce their own auxiliary files.
They generally share the file name of the main \verb|.tex| file.

\begin{technote}
These notes also use this mechanism.
Code examples are written inside the \verb|.tex| source files.
Some special commands write the example to a temporary file,
which is then read twice:
once to print out the code, and then again to evaluate the results.
\end{technote}

These auxiliary files can also be read and written by other programs.
The prime example is the \prg{bibtex} program.\label{bibtex process}
Processing a database of bibliographic entries is too complicated to do
inside the \TeX{} programming environment.
Therefore, a separate program is used.%
\footnote{The newer \prg{biber} compiler used by \pkg{biblatex} package works
in a similar way to that described here.}
It works like this:
\begin{enumerate}
\item You write bibliographic data in a \verb|.bib| file.\index{bib file@.bib file}
    See \Cref{sec:bibliography} for the syntax.
\item You write citation commands in the \verb|.tex| source code.
\item When the \LaTeX{} compiler encounters citations,
    it writes some special commands in the \verb|.aux| file.
\item When the \prg{bibtex} program is invoked, it reads the \verb|.aux| file.
    It creates a combined list of all citations,
    and outputs the commands to typeset a bibliography into the \verb|.bbl| file.
\item When \LaTeX{} is run again,
    it reads the \verb|.bbl| file and prints the bibliography.
\end{enumerate}
%
The \LaTeX{} compiler and \prg{bibtex} are decoupled in the sense that
you only need to run \prg{bibtex} when you need to update the bibliography.

In fact, arXiv does not run any bibliographic compilers at all.
They require you to submit the \verb|.bbl| file created by your preferred compiler.
(This probably has to do with two facts:
1. There is more than one bibliography compiler in wide use.
2. The bibliographic databases can contain a lot of data,
also including uncited works.)



%
%
\subsection{Splitting your source into multiple files}

The \cmd{input} and \cmd{include} commands can be used to include additional \verb|.tex| files.
This makes it possible to e.g.\ write each chapter of a long document in a separate file.

\begin{practices}
While it would sound reasonable to split even articles into section-specific files,
there are two reasons not to do so:
\begin{itemize}
\item If you are sharing files with collaborators,
    the complexity of keeping files in sync grows faster than linear in the number of files.
\item Many journals prefer to have the submission in one \verb|.tex| file
    for similar logistical reasons.
\end{itemize}
%
As we see below, there can also be some complexity in setting up the editor.

Therefore my recommendation is:
only split the document if you are preparing a book.
This advice might be extended to theses, and lecture notes
edited by a limited amount of people simultaneously.
These very notes are split into one file per chapter.\footnotemark

When I started preparing this course,
this was the piece of advice I got the most from other \TeX{}nicians.
Consider yourself warned.
\end{practices}
\footnotetext{And suffer from some associated problems.
The ``main file detection'' heuristics of my editor do get confused by this chapter
where several \texttt{\textbackslash documentclass} commands appear.}

There is a minor difference in the two commands.
When \cmd{input} is called with the name of a \verb|.tex| file,
the compiler acts as if the contents of the file were placed in that position.
You could replace the input operation by copy-pasting the file contents.%
\footnote{Some environments do not allow \texttt{\textbackslash input} inside them.}

On the other hand, \cmd{include} finishes the current page
before processing file contents.
This involves placing any queued floats (see \Cref{sec:floats}).
That makes it mostly suitable for including separate chapters.
Every included file gets its own \verb|.aux| file.

The \cmd{includeonly} command temporarily restricts the compilation to a subset of the included files.
This can be a neat way to reduce compilation times on a long document.
Since each file has its own \verb|.aux| file,
cross-references to uncompiled chapters might work (but be outdated!).

\begin{ExampleCode}
% Preamble
\includeonly{intro,discussion}

\include{intro} % Input intro.tex
\include{methods} % Input methods.tex
\include{results} % Input results.tex
\include{discussion} % Input discussion.tex
\end{ExampleCode}

\begin{gotcha}
\cmd{include} only produces a warning if it cannot find the specified file.
Also, some packages work unreliably with \cmd{include}.

Do not use \cmd{includeonly} when preparing the final copy of your document,
since some of the \verb|.aux| files could be outdated.
\end{gotcha}

\begin{practices}
If you separate chapter contents into their own files,
I highly recommend keeping the ``main file'' very short
-- consisting only of the preamble and \cmd{include} commands.
\end{practices}

In either case,
the included \verb|.tex| file must not contain a preamble --
there already was one in the main file.
Conversely, this means that the separated files cannot be compiled on their own.

There might be some editor-specific support for setting the main file of your project.
This allows you to hit \emph{Compile} while editing a chapter file,
and the main file gets compiled instead.

\begin{overleaf}
You can set the main file in the settings menu at top left of the editor.
\end{overleaf}




%
%
%
\section{Commands and environments}

\begin{practices}
When should you define your own commands?
Generally, the less customization you have,
the easier your manuscript is for the journal publication process and your coauthors.
At the same time, good commands make the code semantically meaningful.

I personally find \verb&\norm{...}& easier to read than \verb&\left\|...\right\|&,
and \verb|\Prob| certainly better than \verb|\mathbb P|,
but others could find those an overkill.
This is a hard balance to strike.

There is just one strict rule:
never repurpose the name of an existing base \LaTeX{} command.
It will cause endless trouble when the journal style or some package tries to use the original command.
\end{practices}


\subsection{Defining commands}
\index{macros}
\TeX{} is a macro language.
This means that there are special source code tokens (\emph{macros}),
that are \emph{expanded} into sequences of more tokens
(including more macros, which are expanded recursively).
The core system includes only a few commands for manipulating internal state and putting out text,
and the rest is achieved via macro expansion.

That was a mouthful, so let us see an example.
In \LaTeX{} macros are defined with the \cmd{newcommand} command.

\begin{VerbatimOut}{\jobname.tmp}
\newcommand{\hello}{Hello world!}

\hello
\end{VerbatimOut}
\ShowExample

Here \cmd{newcommand} takes two arguments:
the first is the name of the macro to define, and the second is what the macro expands to.
In \TeX{} things are grouped with the \verb|{}| braces.
(The first set of braces is technically unnecessary, but it looks cleaner in my opinion.)

Let us see another example where the command is used repeatedly,
and also expanded inside other commands:
\indexcmd{MakeUppercase}
\begin{VerbatimOut}{\jobname.tmp}
\newcommand{\hello}{Hello world}

--\hello, they whispered.\\
--I said, \MakeUppercase{\hello}!
\end{VerbatimOut}
\ShowExample

Since the macros are expanded recursively until there is nothing more to expand,
you can write things that are semantically very unclear,
but comprehensible to a computer:
\begin{VerbatimOut}{\jobname.tmp}
\newcommand{\hi}{^\infty}
\newcommand{\underscore}{_}
\newcommand{\lo}{\underscore{i=1}}

\[ \sum\lo\hi \]
\end{VerbatimOut}
\ShowExample
%
The expansion goes something like this:
\begin{enumerate}
    \item \verb|\sum\lo\hi|
    \item \verb|\sum\underscore{i=1}\hi|
    \item \verb|\sum_{i=1}\hi|
    \item \verb|\sum_{i=1}^\infty|
\end{enumerate}
So the end result is the same as if one had written the sum sensibly from the beginning.



\begin{warning}
In plain \TeX{} macros are defined with \obscmd{def} and \obscmd{let}.
If you see code using either,
you have entered the ``shoot your own foot'' territory.\footnotemark
\end{warning}
\footnotetext{Since you asked, the difference between the two is whether the contents of the macro
are expanded at usage or definition time.
Neither protects you against overwriting existing macros.}
\quiettodo{Keep these on the same page!}


The \TeX{} compiler works in two basic modes: text mode and math mode.
Some commands (for example, \verb|\sqrt|) are only usable in math mode.

How to define a command that works \emph{both} in text and math mode?
You can use the \cmd{ensuremath} command: in text mode it wraps its contents inside \verb|$|,
and in math mode it does nothing:
%
\begin{VerbatimOut}{\jobname.tmp}
\newcommand{\magic}{\ensuremath{\sqrt 2}}

The number \magic{} satisfies
\[
\magic^2 = 2.
\]
\end{VerbatimOut}
\ShowExample




%
\subsection{Arguments to commands}

To pass arguments to macros, we can indicate their number with an optional argument
between the macro name and definition.
These arguments can then be accessed in the macro definition with \verb|#1|, \verb|#2|, and so on.

\begin{VerbatimOut}{\jobname.tmp}
\newcommand{\say}[2]{#1 says ``#2''!}

\say{Petri}{Hi}
\end{VerbatimOut}
\ShowExample

Arguments are often wrapped in the \verb|{}| braces,
but it is not actually necessary -- in a very specific case.
By default, \LaTeX{} interprets a single letter or a number as an argument.
The braces extend the argument to a longer stretch.

This means that all of the following are equivalent:

\begin{VerbatimOut}{\jobname.tmp}
\[
\frac{1}{2}
= \frac 1 2
= \frac12.
\]
\end{VerbatimOut}
\ShowExample

Do note the last one -- \LaTeX{} command names can only consist of letters,
so the number 1 is not interpreted as part of the command name but an argument.
There is no requirement to separate the name and a following number.
(I do find the last example hard to read, though.)
Conversely, whitespace won't separate longer arguments; you really need the braces:

\begin{VerbatimOut}{\jobname.tmp}
\[
\frac 12 34
\neq \frac {12} {34}.
\]
\end{VerbatimOut}
\ShowExample

However, commands are interpreted as single tokens.
This happens regardless of whether the command would expand to several tokens.

\begin{VerbatimOut}{\jobname.tmp}
\newcommand{\magic}{314 159}
\[ \frac \magic \pi \]
\end{VerbatimOut}
\ShowExample

\begin{gotcha}
Some built-in macros swallow the whitespace that follows them.
If a word space is actually needed, you can feed the command an empty group \verb|{}|:
\begin{VerbatimOut}{\jobname.tmp}
\LaTeX programming\\
\LaTeX{} programming
\end{VerbatimOut}
\ShowExample
\end{gotcha}


%
\subsection{Groups and scopes}

\index{group}\index{scope}
\label{ex:font scope}
More precisely, the braces delimit a \emph{group}.
A group is handled as a single argument to a command.
Additionally, they serve as a \emph{scope} for commands that change
how all the following text is output.
For example, the font-sizing commands like \cmd{tiny} and \cmd{Large}
affect the size of all text that follows them.
However, this effect only lasts until the group is closed with a \verb|}|.

\begin{VerbatimOut}{\jobname.tmp}
{\tiny I am small}
and I am normal
and {\Large I am large}
\end{VerbatimOut}
\ShowExample

If you forget about this and just write \cmd{tiny} without any scoping,
you will have tiny text until the end of document (or the next font size command).

\begin{VerbatimOut}{\jobname.tmp}
\tiny I am small and
{\Large I am large}
and I am tiny again
\end{VerbatimOut}
\ShowExample

There is one place where the braces do not delimit a group:
in the definition of commands.
In the following example, \verb|\mouse{Squeak}| is expanded into
\verb|\tiny Squeak| and not into \verb|{\tiny Squeak}|.
Therefore the effect persists onto the following line.
%
\begin{VerbatimOut}{\jobname.tmp}
\newcommand{\mouse}[1]{Mouse: \tiny#1.}

\mouse{Squeak}\\
I: Oops.
\end{VerbatimOut}
\ShowExample
%
The scope can be introduced here by adding \verb|{}| into the command definition:
%
\begin{VerbatimOut}{\jobname.tmp}
\newcommand{\mouse}[1]{{Mouse: \tiny#1.}}

\mouse{Squeak}\\
I: Alright.
\end{VerbatimOut}
\ShowExample

Scopes also affect things like \cmd[scope]{newcommand}:
the command \verb|\mouse| defined above only exists
within the example block, and is not accessible beyond it.



%
\subsection{Optional arguments}

Some commands also have optional arguments.
Instead of braces, these are passed within brackets \verb|[]|.
A basic example is the \cmd{sqrt} command
that produces not only square roots, but general roots:
\begin{VerbatimOut}{\jobname.tmp}
$\sqrt{7}$,
$\sqrt[3]{7}$.
\end{VerbatimOut}
\ShowExample

Another example is the optional argument to \cmd{cite} command,
which indicates a precise position within the cited work:
\verb|\cite[Page 40]{TLC}| produces \cite[Page 40]{TLC}.
(Here \verb|TLC| is the bibliography key for \emph{The \LaTeX{} Companion};
we will discuss this more in \Cref{sec:bibliography})

\begin{gotcha}
Inside an optional argument, \LaTeX{} interprets the first \verb|]| it sees as the closing bracket.
This means that if you need to use \verb|[]| \emph{inside} an optional argument
(say, as an optional argument to an inner command), you need to wrap things in braces.
Quite often, you might need even \emph{two sets of braces}.
Compare the two citations:
%
\begin{VerbatimOut}{\jobname.tmp}
\cite[{{Page [40] maybe?}}]{TLC}\\
\cite[Page [40] maybe?]{TLC}
\end{VerbatimOut}
\ShowExample
%
The first citation is shown correctly.
In the second, the optional argument is interpreted to be ``\verb|Page [40|''
and the citation name then ``\verb|m|'' (only a single letter since it was not wrapped in braces).
The remaining ``\verb|aybe?]{TLC}|'' is then normal body text.
\end{gotcha}

\begin{gotcha}
\LaTeX{} ignores whitespace between a command and its optional argument.
This might sometimes lead to surprising behaviour.
Here the second list item is interpreted as an optional argument that replaces the bullet symbol:
\indexcmd{item}
%
\begin{VerbatimOut}{\jobname.tmp}
\begin{itemize}
\item Cookies
\item [Maybe cake?]
\item Drinks
\end{itemize}
\end{VerbatimOut}
\ShowExample
\end{gotcha}


The syntax for optional arguments is not always clear:
sometimes they precede the real arguments, sometimes they follow them.
Sometimes they consist of just one thing,
sometimes they can be a list of things
(see the discussion of \cmd{usepackage} later in this chapter).


%
\subsection{Replacing existing commands}

Sometimes it is useful to overwrite an existing command.
One common example is rewriting \cmd{epsilon} to actually mean \cmd{varepsilon},
since many consider the variant $\varepsilon$ prettier than the regular $\epsilon$.

It is not possible to write \verb|\newcommand{\epsilon}{\varepsilon}|,
since \LaTeX{} rightly complains about \verb|\epsilon| being already defined.
You could be accidentally overwriting a command used elsewhere in the document.
You have to make your intentions clear by using \cmd{renewcommand}:

\begin{VerbatimOut}{\jobname.tmp}
Old epsilon: $\epsilon$,\\
\renewcommand{\epsilon}{\varepsilon}
New epsilon: $\epsilon$.
\end{VerbatimOut}
\ShowExample
%
Again, the redefinition of a command lasts only for the current scope.
Once the scope is closed, \verb|\epsilon| again means the old regular symbol.
To redefine a command within the entire document,
you need to call \cmd{renewcommand} in the document preamble.

Here is an example of \cmd{newcommand} and \cmd{renewcommand} with arguments.
The two commands have matching syntax.
Note that the new definition is free to have a different number of arguments.

\begin{VerbatimOut}{\jobname.tmp}
\newcommand{\dual}[2]{(#1 \mid #2)}
Mathematicians: $\dual{a}{b}$.\\
\renewcommand{\dual}[2]
  {\langle#2 \mid #1\rangle}
Physicists: $\dual{a}{b}$.
\end{VerbatimOut}
\ShowExample

The \cmd{DeclareCommandCopy} robustly copies the current definition of a command.%
\footnote{This can also be done with raw \TeX{} primitives, which are to be avoided.}
It is then possible to renew the definition, and still access the previous version.
Let us illustrate this by swapping the meanings of \verb|\epsilon| and \verb|\varepsilon|:
%
\begin{VerbatimOut}{\jobname.tmp}
Epsilon $\epsilon$ and varepsilon $\varepsilon$

\DeclareCommandCopy{\oldepsilon}{\epsilon}
\DeclareCommandCopy
    {\oldvarepsilon}{\varepsilon}
\renewcommand{\epsilon}{\oldvarepsilon}
\renewcommand{\varepsilon}{\oldepsilon}

Epsilon $\epsilon$ and varepsilon $\varepsilon$
\end{VerbatimOut}
\ShowExample

\begin{latexthree}
This command is part of the \LaTeX3 programming interface.
It requires a relatively recent (2020 or later) \LaTeX{} version.
\end{latexthree}


%
\subsection{Defining environments}

\index{environments}
Environments encapsulate larger blocks of text.
They also form implicit groups.

\begin{VerbatimOut}{\jobname.tmp}
\begin{center}
\renewcommand{\epsilon}{\varepsilon}
Centered text and $\epsilon$
\end{center}

\begin{flushright}
Right-aligned text.
Here we have the old $\epsilon$.
\end{flushright}
\end{VerbatimOut}
\ShowExample

To define an environment, we use the \cmd{newenvironment} command.
This command takes three arguments: the name of the environment
and code to expand at the beginning and the end of the environment.

\begin{VerbatimOut}{\jobname.tmp}
\newenvironment{cool}
    {A mathmo enters the lab.\par}
    {\par The mathmo leaves the lab.}

\begin{cool}
A massive explosion occurs.
\end{cool}
\end{VerbatimOut}
\ShowExample
%
(If you're wondering about the \cmd{par} commands,
they are used to ensure that the first and last lines are their own paragraphs.)

There is also \cmd{renewenvironment} that works like \verb|\renewcommand|.

Since environments are groups,
it is possible to change font characteristics for the duration of the environment:

\begin{VerbatimOut}{\jobname.tmp}
\newenvironment{mouse}{\tiny}{}

Ordinary text.
\begin{mouse}
Very small and very squeaky text.
\end{mouse}
Again ordinary text.
\end{VerbatimOut}
\ShowExample
%
Note that here the end code is empty;
the font properties are reset automatically as the group ends.

\begin{gotcha}
If the begin/end code of your environment spans multiple lines,
you need to be careful with line breaks.
The extra whitespace might cause \LaTeX{} to output an unintended empty space
or even a paragraph break.
To avoid line breaks to be interpreted as line breaks,
you can end each line in the environment definition with \verb|%|
-- the comment character shallows the line break.

This same thing applies to empty lines before and after environment usage
-- the usual paragraph-breaking rules apply.
If you don't want to start a new paragraph after the environment ends,
do not leave an empty line between \verb|\end{...}| and the following text.
(For visual separation in the code, I prefer a line containing just \verb|%|.)
\end{gotcha}




%
%
%
\section{Diagnosing errors}

Macro languages were popular in the 1980s, back when 640 kilobytes was enough memory for anyone.
An unfortunate consequence of \TeX's stability is that the compiler still operates under this worldview.
The source code is read exactly once from top to bottom,
and if the code is not correct, error messages can be extremely cryptic.

\begin{overleaf}
Some \LaTeX{} distributions are set up to ignore some errors.
For example, Overleaf is quite good at ignoring missing \verb|$| signs and other small typos.
You should really pay attention to red symbols in the source code margin
and next to the \emph{Recompile} button!
\end{overleaf}

The compiler gives three forms of output: information, warnings and errors.
Graphical \LaTeX{} editors usually only show the latter two.
(Information is printed in the console output.
It includes the current source file and page number that the compiler is processing,
which can help diagnose a stuck compilation.)

\index{warnings}
Warnings are just as the name says: the document can still be compiled,
but you should check whether you have gotten what you intended.
Generally, the warning messages are very descriptive:

\medskip\noindent\emph{Overfull or underfull hbox.}\\*
A line could not be breaked in a nice way.
See \Cref{sec:overfull} for how to solve this.

\medskip\noindent\emph{Citation or label undefined.}\\*
\LaTeX{} could not recognize a label that you tried to reference.
If the label or bibliography entry was newly added, a recompilation might fix this.
Otherwise you have forgotten to define it at all, or just forgotten how to spell it.
See \Cref{sec:crossref,sec:bibliography}.

\medskip\noindent\emph{Label(s) may have changed. Rerun to get cross-references right.}\\*
Indeed, you have added a new label since the last compilation.
Just recompile the file.

\medskip\noindent\emph{Temporary extra page added at the end. Rerun to get it removed.}\\*
This can happen if the document becomes shorter than in the last compilation.
\LaTeX{} tries to place the processing that happens at \verb|\end{document}|
to the final page, but it does not know the final number of pages until it is too late
(hence it looks at the previous compilation for a hint).
As the message says, there is an extra page explaining the issue at the end.
Recompile and it goes away.


\begin{practices}
You should always check for warnings before submitting a document.
It's a bit embarrassing to publish a document with [\textbf{?}] citations, after all.

Overfull and underfull hboxes are usually \emph{not worth fixing}
until the final typesetting phase,
since very small changes to the text or style can drastically change the line breaking.
\end{practices}


\index{errors}
Errors, on the other hand, halt the compiler altogether.
The compiler can try to ignore errors and recover itself,
but at that point \emph{it is guessing} what you tried to mean,
and might get even more confused.
Quite often the internal state is so messed up, \TeX{} can only spew more errors.


\begin{practices}
Recompile often.
It is much easier to locate an error when you have modified only a small region of the code.

Always recompile after you modify a command definition
or do a find-and-replace operation.
These are risky.

If your document takes a long time to compile,
find a way to speed it up
(skip complicated TikZ pictures in draft mode, only include chapters you're working on, etc.).
If recompilation breaks your flow, you won't do it often enough.

For some pointers for conditionally skipping parts of pictures, see page~\pageref{ex:booleans}.
\end{practices}


\medskip\noindent\emph{[100+ error messages]}\\*
Did you just modify the definition of a command?
If so, then you probably introduced a typo there.

If not, this is a strong sign that \TeX{} failed to recover from an error.
Scroll to the \emph{very first} error message and fix it.
The later error messages are misleading,
and will go away once the actual error is fixed.

If the cause of the error is a command used inside a sectioning command or table specification,
you may have hit a robustness issue; see \Cref{sec:robustness}.

\medskip\noindent{\em \verb|\begin{equation}| on input line 7 ended by \verb|\end{equation*}|}\\*
Exactly what is says: there is a mismatched begin/end combination.
If the message says \verb|\end{document}|, then the end command is missing altogether.

\medskip\noindent{\em Missing \verb|$| inserted}\\*
You have tried to use a math-mode command while in text mode.
If you want to define a custom command that works in both modes,
you can wrap mathematical symbols in it within \cmd{ensuremath}.

\medskip\noindent\emph{Bad math environment delimiter}\\*
Conversely, do you have an extra \verb|$| inside a display math environment?

\medskip\noindent{\em Misplaced alignment tab character \verb|&|}\\*
\medskip\noindent{\em Extra alignment tab has been changed to \verb|\cr|}\\*
You have a bit too many \verb|&| characters per line,
or are using an equation environment that does not support them at all.

\medskip\noindent{\em Package amsmath Error: \verb|\begin{split}| won't work here.}\\*
You need to wrap the environment inside \verb|equation| or one of its friends.

\medskip\noindent\emph{Missing character: There is no \emph{\dots} in font nullfont!}\\*
If this happens inside a TikZ picture, you have very likely mistyped a command or option.
Check the code line shown above the error message.

\future{More common error messages}



%
%
%
\section{Document structure}\label{sec:document structure}

Let us then look at the basic structure of a \verb|.tex| file.
Everyone reading these notes is assumed to have seen such a file more than once,
but we will spend some time on some nuances.
Bear with me even if this sounds trivial!

\begin{practices}
I would advocate for starting every project from an empty \verb|.tex| file.
The problem with ``heritage'' templates is that they accumulate a lot
of unnecessary package dependencies and custom commands.
I've seen files where the same package is loaded three times.

By starting from an empty file
and only adding the customizations you need for the particular project,
you help maintain your ``code hygiene''.
\end{practices}

Let us start with the minimal example below.

\begin{ExampleCode}[numbers=left]
\DocumentMetadata{}
\documentclass[a4paper]{article}

\fontencoding{OT1} % Read note below!
\usepackage[hidelinks]{hyperref}

\title{My first document}
\author{Firstname Lastname}
\date{\today}

\begin{document}

\maketitle

% Rest of content here...

\end{document}
\end{ExampleCode}

We discuss the first line in a \LaTeX3 note below.
On the second line, we load a \LaTeX{} document class.
The document class determines the basic layout of your document,
and it is where several basic commands like \cmd{maketitle} are defined.
We will look at some different document classes and arguments in the next subsection.

Lines 1--10 are collectively known as the \emph{preamble}.\index{preamble}
This is the best place to define new commands and do other setup.
Additional packages are also loaded here; see \Cref{sec:loading packages}.

\begin{latexthree}
What's interesting in the above example is the one package that is \emph{not} loaded.
The \pkg{inputenc} package used to be very important to load,
since it told \LaTeX{} about the encoding of non-English characters.
Since 2018 \LaTeX{} has followed the rest of the world
and uses UTF-8 encoding by default.

What does this mean for you?
If you create a new file in any reasonably modern \LaTeX{} editor,
you get the correct encoding and don't need to load \pkg{inputenc}.

However, if you modify a sufficiently aged file that contains non-English characters,
you might stumble upon legacy encodings like \texttt{latin1} or \texttt{cp1252}.
In such files, the \pkg{inputenc} package must be loaded with the proper optional argument.
\end{latexthree}

The \verb|\fontencoding| command tells \LaTeX{} that Unicode characters will appear
not only in the source code, but also the final output
-- thus the font must be interpreted in a compatible way.
However, this command should only be used with the traditional pdfTeX compiler;
if you use the newer LuaLaTeX or XeLaTeX compilers,
this command might cause subtly worse output.
See page~\pageref{rem:font encoding} for more explanation.


Trying to output any text before the \verb|\begin{document}| line is an error.
\indexenv{document}%
When the compiler reaches that line,
a lot of stuff happens behind the scenes to prepare \LaTeX{} for actually outputting pages.

Similarly, the \verb|\end{document}| line is necessary.
At that point, a lot of code is executed to make sure that everything is output properly.
Any text written below that line is ignored.
(I do not recommend writing anything there!)

\begin{latexthree}
An important part of the \LaTeX3 project is revising the PDF output
to include accessibility information:
for example, tagging section headings as headings and not just bold text in big font.
Since this might cause issues with some packages, the new behaviour is opt-in.

If you write \indexcmd{DocumentMetadata}\verb|\DocumentMetadata{}|
before the \verb|\documentclass| declaration, you opt in to these new features.
This command also enables new functionality in e.g.\ the \pkg{hyperref} package.
\end{latexthree}


%
\subsection{Document classes}\label{sec:document classes}

\begin{practices}
Journals commonly define their own document classes, based on one of the standard classes.
The discussion below only applies to the documents where you are in charge of the style.
Always look at the journal instructions for preparing the published version of your article.
\end{practices}

\index{document classes}
There are three document classes of interest included in base \LaTeX{}:

\begin{description}
\item[article] As the name suggests, this should be used for articles, short notes, and such.
    The \cmd{maketitle} command does not create a separate title page,
    and the highest-level sectioning command is \cmd{section}.
    There is no page break between sections.
\item[report] This class is suitable for e.g.\ a thesis, lecture notes, or a longer article.
    The present notes use this class.
    There is a separate title page,
    and the highest-level sectioning command is \cmd{chapter}.
    Each chapter begins on a new page.
\item[book] This is the heaviest of all the classes.
    You get a lot of empty pages, just like in a real printed book.
    If you find yourself using this class,
    you have agreed to something monumental.
\end{description}
%
There is also a \textbf{letter} document class,
which understandably sees little use nowadays.
But it is still there if you need it!

Options passed to document classes are interesting in that
\emph{they are also passed to all packages}.
If you pass \verb|a4paper| to the document class,
then you don't need to pass it again to the \pkg{geometry} package.

Some options are supported by all the basic document classes:

\begin{description}
\item[a4paper] This is self-explanatory.
    By default, \LaTeX{} assumes the American letter paper size.
\item[10pt, 11pt, 12pt] Sets the body font size.
    Fonts for section headers, footnotes, etc.\ are scaled accordingly.
    The default is 10~points.
\item[oneside, twoside] Whether the margins are equal
    or alternating between odd and even pages.
    For example this document (which is aimed for consuption on a screen)
    uses \verb|oneside|, but a printed report should specify \verb|twoside|.
\item[openright, openany]
    Whether chapters always begin on a right-hand side page (default for book)
    or any page (default for report).
    You should consider \verb|openright| for a printed thesis
    and \verb|openany| for electronic version.
    Not applicable to the article class where chapters are not supported at all.
\item[notitlepage, titlepage] Whether the title is set on a separate page.
\item[fleqn] Instead of centering, left-aligns display formulas.
\item[twocolumn] Sets the text in two columns.
\end{description}


A very common alternative document class is \textbf{amsart}.\indexpkg{amsart}
It is developed by the American Mathematical Society,
and some prefer its style to that of \textbf{article}.
It is a drop-in replacement for \textbf{article} and supports the same options.

Other common classes include those from \pkg{koma-script}
(drop-in replacements for all standard classes)
and \pkg{memoir} (intended for longer documents),
which both provide a lot of flexibility.
They both come with extensive documentation for those who wish to venture into that rabbit hole.


%
\subsection{Loading packages}\label{sec:loading packages}

In the previous example, we loaded the \pkg{hyperref} package with:
\begin{ExampleCode}
\usepackage[hidelinks]{hyperref}
\end{ExampleCode}
Options can be passed to packages inside the brackets.
Here we pass the \verb|hidelinks| option that suppresses the coloured boxes around clickable links.
Some packages also take options with a \verb|key=value| notation.

In addition to the options passed explicitly,
all the options passed to the document class are also forwarded to the package.

\begin{practices}
You should always load \pkg{hyperref}.
It not only turns cross-references into clickable links,
but also adds section headers to the PDF table of contents
(usually found in the sidebar of any reader application).
Your readers will appreciate this navigation aid.
\end{practices}

\index{packages!finding}
CTAN, the \emph{Comprehensive \TeX{} Archive Network},
is the repository for \LaTeX{} packages.
It can be browsed at \url{www.ctan.org}.

Generally \LaTeX{} distributions either contain the whole CTAN,
or are able to download packages from there as needed.
You should check out how you can keep your distribution up to date,
as new versions of packages are continually released.

Most importantly, all major packages listed on CTAN have good documentation there.
The documentation typically includes usage examples, a complete reference,
and possible compatibility issues with other packages.
For example, you can find the (very extensive!) documentation of \pkg{hyperref}
at \url{www.ctan.org/pkg/hyperref}.
They are also available at \url{www.texdoc.org}.

\begin{description}
\item[babel] Support for languages other than English.
    See \Cref{sec:babel}.
\item[cleveref] Automatic cross-reference formatting.
    See \Cref{sec:cleveref}.
\item[enumitem] Customization of list structures.
    See \Cref{sec:lists}.
\item[graphicx] Inclusion of image files.
    Replaces the old \obspkg{graphics} package of early nineties \LaTeX{};
    do not confuse the two.
    See \Cref{sec:pictures}.
\item[mathtools] More mathematical environments and commands.
    Superset of the \pkg{amsmath} package, which is loaded by AMS document classes.
    See \Cref{sec:mathematics}
\item[xcolor] Support for setting text and symbols in colour.
    Replaces the old \obspkg{color} package included in early \LaTeX{}.
    See \Cref{sec:colour}.
\end{description}


\begin{gotcha}\index{packages!loading order}
Quite a few packages modify the standard \LaTeX{} commands
and even the commands defined by each other.
This means that sometimes it is important to load packages in the correct order,
so that the modifications are applied sensibly.
The core packages are usually compatible with each other,
but you should always check the package documentation for possible conflicts.

For example, it is important to load \pkg{ntheorem} before \pkg{hyperref},
since the former modifies the label commands that are also touched by the latter.
Otherwise, you might get non-functioning hyperlinks.
\end{gotcha}



\section{Creating your own style file}

\begin{practices}
As discussed above, it is best to keep an article in one file.
The same can be said also of a thesis.

You should only create a style file if you have multiple documents sharing commands and packages.
For example, a style file is useful for a personal notes folder.
\end{practices}


Internally, \LaTeX{} packages live in \verb|.sty| files.
It is possible to move preamble code into such a file.
If the file is in the same directory as the document,%
\footnote{Or on \TeX's search path, but don't ask me about that.}
it can then be accessed with \cmd{usepackage}.

For example,
\begin{ExampleCode}
\usepackage{mystyle}
\end{ExampleCode}
loads the file called \verb|mystyle.sty|.


Inside the style file, there are a few important things.
First off, the file is started with a special identification header:
%
\begin{ExampleCode}
\NeedsTeXFormat{LaTeX2e}[2020/02/02]
\ProvidesPackage{mystyle}[2024/05/20 mystyle]
\end{ExampleCode}
%
These tell \TeX{} that the file requires \LaTeX{} released on 2~February~2020 or later,
and that the file contains the version of \verb|mystyle| published on 20~May~2024.
(Keeping the latter number up to date is relevant only for package writers,
but it is nice to keep in sync for your own reference.)

After this, you can do everything that you could do in document preamble.
Ideally, you would define your favourite commands here.
One change is that loading packages is done with \cmd{RequirePackage}.

As a complete example, here is a heavily shortened version of the style file for these notes.%
\footnote{As the source code is openly available, you can read the full file as well!}
%
\begin{ExampleCode}
\NeedsTeXFormat{LaTeX2e}[2020/02/02]
\ProvidesPackage{latexcourse}[2024/03/05 latexcourse]

% A simple TODO command, available only when the 'draft' option is set
\DeclareOption{draft}{
    \newcommand{\todo}[1]{\textcolor{red}{\textbf{[TODO: #1]}}}
}
\ProcessOptions\relax

\RequirePackage{mathtools}
\RequirePackage{csquotes}
\RequirePackage[finnish,french,english]{babel}
\RequirePackage[hidelinks]{hyperref}

% Theorem styles for examples
\RequirePackage[hyperref,framed,amsmath,thmmarks,amsthm]{ntheorem}
\theoremstyle{plain}
\newtheorem{theorem}{Theorem}
\end{ExampleCode}

In this example, you could also see how a simple boolean option can be declared.
It is enabled with \verb|\usepackage[draft]{latexcourse}|.
We do not discuss further package development topics here.



%
%
%
\section{Counters}\label{sec:counters}

\LaTeX{} keeps a lot of internal state in variables called \emph{counters}\index{counters}.

\begin{VerbatimOut}{\jobname.tmp}
We are in Chapter~\arabic{chapter}
and its Section~\arabic{section}.

\begin{enumerate}
\item This is item~\arabic{enumi}.
\item This is item~\arabic{enumi}.
  \begin{enumerate}
  \item Subitem~\arabic{enumii}.
  \item Subitem~\arabic{enumii}.
  \end{enumerate}
\end{enumerate}
\end{VerbatimOut}
\ShowExample

The counters seen in the above example are automatically stepped by the sectioning and list commands.
They can be manually manipulated with the \cmd{setcounter} command.
One such example is seen in Väisälä's topology textbook:

\begin{ExampleCode}
\setcounter{chapter}{-1}
\chapter{Prerequisites}

% The chapter name is printed as "0. Prerequisites"
% Note: the counter is set to -1 to compensate for \chapter stepping it
\end{ExampleCode}

It is also possible to add/subtract a value to a counter:
\indexcmd{stepcounter}\indexcmd{addtocounter}%
\begin{VerbatimOut}{\jobname.tmp}
\begin{enumerate}
\item Add one and step:
  \stepcounter{enumi}
\item Add seven and step:
  \addtocounter{enumi}{7}
\item Minus one + step:
  \addtocounter{enumi}{-1}
\item Same as above!
\end{enumerate}
\end{VerbatimOut}
\ShowExample

There are many ways to output the value of a counter:\index{counters!displaying}\label{par:counter format}
%
\begin{VerbatimOut}{\jobname.tmp}
Section~\arabic{section}\\
Section~\alph{section}\\
Section~\Alph{section}\\
Section~\Roman{section}\\
Section~\fnsymbol{section}
\end{VerbatimOut}
\ShowExample
The last command \verb|\fnsymbol| is used for footnote symbols.
Note that the letter-based styles can be capitalized
by using \verb|\Roman| instead of \verb|\roman| etc.

To format numbers as natural-language strings, you can use the \pkg{fmtcount} package.
For example, its \cmd{ordinalstring} command produces strings like ``first'', ``second'', and so on.
There are several capitalization variants,
as well as support for a few languages (including grammatical gender).%
\footnote{Unfortunately, Finnish is not yet among them.}
The package also provides commands for binary and hexadecimal number formatting.

To define your own counters, you can use \cmd{newcounter}:
\index{counters!defining}%
%
\begin{VerbatimOut}{\jobname.tmp}
\newcounter{fact}
\newcommand{\axiom}[1]{\stepcounter{fact}%
    \textbf{Rule \thefact.} #1\par}

\axiom{Don't use plain \TeX.}
\axiom{See the above.}
\end{VerbatimOut}
\ShowExample
%
As we saw above, the value of the counter is accessed by prefixing it with \cmd{the}.
The style of the counter can be changed by redefining this command:
%
\begin{VerbatimOut}{\jobname.tmp}
We're at Fact number~\thefact.

\renewcommand\thefact{\Roman{fact}}

Now it's called Fact~\thefact.
\end{VerbatimOut}
\ShowExample

If you want the counter to reset when another counter is stepped,
you can pass an optional argument (\emph{after} the counter name!) to \cmd{newcounter}.
An example use case is to reset the counter every time a new section is started
(in which case the optional argument would be \verb|[section]|):
%
\begin{VerbatimOut}{\jobname.tmp}
\setcounter{fact}{0}
\newcommand{\axiom}[1]{\stepcounter{fact}%
    \textbf{Rule \thefact.} #1\par}
\newcounter{exc}[fact]
\renewcommand{\theexc}{\roman{exc}}
\newcommand{\except}[1]{\stepcounter{exc}%
  {\tiny Exception~\theexc. #1}\par}

\axiom{Don't use plain \TeX.}
\except{Unless Don Knuth passes by.}
\except{Or you're a masochist.}
\axiom{See the above.}
\except{No exceptions.}
\end{VerbatimOut}
\ShowExample[4]

\begin{gotcha}
This only sees the effect of \verb|\stepcounter| on the another counter;
if you use \verb|\setcounter| to change it, the dependent counter is not reset.
\end{gotcha}

To customize the resetting of pre-existing counters,
you can use the \cmd{counterwithin} command.
For example, to prefix the equation numbers with section numbers,
you would put in the preamble
%
\begin{ExampleCode}
\counterwithin{equation}{section}
\end{ExampleCode}
%
This effect can be undone with the \cmd{counterwithout} command:
%
\begin{ExampleCode}
\counterwithout{equation}{section}
\end{ExampleCode}
%
You can also pass an optional formatting command.
If you like your equations in Roman numbers within section (like 1.iv), then you'd set
%
\begin{ExampleCode}
\counterwithin[\Roman]{equation}{section}
\end{ExampleCode}
%
The \cmd{counterwithin} command does essentially something like
\begin{ExampleCode}
% \counterwithin[\Roman]{equation}{section}
  \renewcommand{\theequation}{\thesection.\Roman{equation}}
\end{ExampleCode}
If you'd prefer not to have the within-counter as prefix (\verb|\thesection.|),
you can renew the counter format again.
This code numbers equations like (1), (2), \dots, and resets the numbering in each section:
%
\begin{ExampleCode}
\counterwithin{equation}{section}
\renewcommand\theequation{\arabic{equation}}
\end{ExampleCode}

\begin{technote}
Counters are always in a global scope.\index{scope!counters}
That is, the definition of a counter does not disappear as the group is closed.
If you would like to use the same counter name again in a later context,
you can (or rather, must) reset and reuse the previous counter.

Due to this, you should probably define your counters in the preamble.
\end{technote}


%
%
%
\section{\emph{Further topics*}}

%
%
\subsection{Control flow}\label{sec:if}

\TeX{} does have syntax for basic control flow like \emph{if} statements,
but the \pkg{ifthen} package makes it much nicer to use.
The \cmd{ifthenelse} command takes three arguments:
an expression, what to do if it is true, and what to do if it is false.
%
\begin{VerbatimOut}{\jobname.tmp}
\ifthenelse{\thepage>10}
    {We're past page~10.}
    {We haven't passed it yet.}
\ifthenelse{\thepage>50}
    {We're also past page~50.}
    {Yet page~50 is still ahead.}
\end{VerbatimOut}
\ShowExample
%
The syntax allows basic comparisons of counters with
\verb|<|, \verb|=|, and \verb|>|.
There is also the \cmd{isodd} command that is useful with page numbers.
Lengths (\Cref{sec:lengths}) can be compared by wrapping the comparison inside \cmd{lengthtest}.
See the package documentation for all expressions.

It is also possible to define and test boolean variables
that have value equal to \verb|true| or \verb|false|:\label{ex:booleans}
%
\begin{VerbatimOut}{\jobname.tmp}
\newboolean{MyBool}
\ifthenelse{\boolean{MyBool}}
    {It is true!}{It is false!}

\setboolean{MyBool}{true}
\ifthenelse{\boolean{MyBool}}
    {It is true!}{It is false!}
\end{VerbatimOut}
\ShowExample

The package also provides a \cmd{whiledo} command that provides a primitive loop.
%
\begin{VerbatimOut}{\jobname.tmp}
\newcounter{mynumber}

\whiledo{\themynumber<6}{%
\stepcounter{mynumber}
\arabic{mynumber} is \Roman{mynumber}\\}
\end{VerbatimOut}
\ShowExample

However, in many cases the \cmd{foreach} command provided by \pkg{pgffor} is easier.
Since the \pkg{pgffor} package is part of TikZ,
we discuss it along TikZ in \Cref{sec:pgffor}.


%
%
\subsection{Robustness}\label{sec:robustness}

The design of \TeX{} as a macro language poses some challenges.
One is controlling the time and place where macros are expanded.

Some commands like \cmd{section} store their contents in the auxiliary file:
the section title is also used for setting the table of contents.
Commands like \cmd[fragility]{ifthenelse} cannot be used in this context.
They are called \emph{fragile} commands.\index{fragility}\index{commands!fragile}

The commands that expand to text are generally robust.\index{robustness}\index{commands!robust}
Similarly, most \LaTeX{} commands are nowadays robust.

It is very rare to see a robustness issue,
but its telltale signs are very confusing error messages
caused by using a command inside a sectioning command, figure caption, or table specification.
If you really need to use a command there,
you can try prefixing its use with \cmd{protect}.


%
%
\subsection{More on command and style definitions}\label{sec:latex3 commands}

\LaTeX3 provides a completely revamped system for defining commands.
If you want optional arguments or starred forms,
you should use the new system.
For environments, it offers a clearer syntax for parameters
and even capturing the environment contents.
It is also a bit more robust in places.

The new system is documented in ``\emph{\LaTeX{} for authors}'' distributed with \LaTeX.
It can be accessed by the name \texttt{usrguide} at \url{www.texdoc.org}
or with the \verb|texdoc| command-line utility.

\future{Adding options to own packages}

